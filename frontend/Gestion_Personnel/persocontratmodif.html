<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../style.mot_pass.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <title>PersoManager</title>
</head>

<body>
  <!-- üîπ Barre de navigation -->
  <nav class="navbar">
    <div class="logo">
      <h1>Modification contrat</h1>
    </div>

    <div class="nav-links">
      <ul>
        <!-- ‚úÖ Bouton Retour stylis√© -->
        <li>
          <a href="page_de_garde_gestion_personnel.html" class="btn-retour">
            <i class="fas fa-arrow-left"></i> Retour
          </a>
        </li>

        <!-- Nom utilisateur -->
          <li class="Util2">
          <label style="color: white;">Utilisateur :</label>
          <span class="nom">---</span>
        </li>

        <!-- Bouton D√©connexion rouge -->
        <li>
          <a href="#" id="btn_quitter" class="btn-logout">
            <i class="fas fa-sign-out-alt"></i> D√©connexion
          </a>
        </li>
      </ul>
    </div>

    <img src="../Image/menu_humberger.JPG" alt="menu" class="menu_humberger">
  </nav>

  <!-- üîπ Contenu principal -->
  <header>
    <div class="formulaire_saisie">
      <form id="postForm" class="detail">
        <div>
          <table>
            <tr>
              <td><label for="nom_personnel">Nom</label></td>
              <td>:</td>
              <td><input type="text" id="nom_personnel" readonly></td>
            </tr>

            <tr>
              <td><label for="prenom_personnel">Pr√©nom</label></td>
              <td>:</td>
              <td><input type="text" id="prenom_personnel" readonly></td>
            </tr>

            <tr>
              <td><label>Type de contrat</label></td>
              <td>:</td>
              <td>
                <select id="Type_contrat">
                  <option value="essai">Essai</option>
                  <option value="cdd">CDD</option>
                  <option value="cdi">CDI</option>
                  <option value="prestateur">Prestateur</option>
                </select>
              </td>
            </tr>

            <tr>
              <td><label>Date du contrat</label></td>
              <td>:</td>
              <td><input type="date" id="Date_contrat"></td>
            </tr>

            <tr>
              <td><label>D√©but du contrat</label></td>
              <td>:</td>
              <td><input type="date" id="Debut_contrat"></td>
            </tr>

            <tr>
              <td><label>Fin du contrat</label></td>
              <td>:</td>
              <td><input type="date" id="Fin_contrat"></td>
            </tr>

            <tr>
              <td><label>Fonction</label></td>
              <td>:</td>
              <td><input type="text" id="Fonction"></td>
            </tr>
          </table>

          <button type="submit" class="btn_valider">Enregistrer</button>
        </div>
      </form>
    </div>
  </header>

  <!-- üîπ Scripts -->
  <script>
    const API_CONTRATS = "http://localhost:5000/api/contrats";
    const API_PERSONNELS = "http://localhost:5000/api/personnels";

    // üü¢ Afficher le nom utilisateur
    const nomUtilisateur = localStorage.getItem("nom_utilisateur");
    if (nomUtilisateur) {
      document.querySelector(".nom").textContent = nomUtilisateur;
    } else {
      window.location.href = "../index.html";
    }

    // üü• Bouton Quitter
    document.getElementById("btn_quitter").addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.removeItem("nom_utilisateur");
      window.location.href = "../index.html";
    });

    // üîπ R√©cup√©ration des param√®tres dans l‚ÄôURL
    const urlParams = new URLSearchParams(window.location.search);
    const contratId = urlParams.get("id");
    const nomPerso = urlParams.get("nom");
    const prenomPerso = urlParams.get("prenom");

    if (nomPerso) document.getElementById("nom_personnel").value = nomPerso;
    if (prenomPerso) document.getElementById("prenom_personnel").value = prenomPerso;

    if (!contratId) {
      alert("Aucun contrat s√©lectionn√© !");
      window.history.back();
    }

    // üîπ Charger les donn√©es du contrat existant
    fetch(`${API_CONTRATS}/${contratId}`)
      .then(res => res.json())
      .then(contrat => {
        const selectType = document.getElementById("Type_contrat");
        if (contrat.Type_contrat) {
          selectType.value = contrat.Type_contrat.toLowerCase();
        }

        document.getElementById("Date_contrat").value = contrat.Date_contrat ? contrat.Date_contrat.split("T")[0] : "";
        document.getElementById("Debut_contrat").value = contrat.Debut_contrat ? contrat.Debut_contrat.split("T")[0] : "";
        document.getElementById("Fin_contrat").value = contrat.Fin_contrat ? contrat.Fin_contrat.split("T")[0] : "";
        document.getElementById("Fonction").value = contrat.Fonction || "";
      })
      .catch(err => {
        console.error("Erreur lors du chargement du contrat :", err);
        alert("Impossible de charger le contrat !");
        window.history.back();
      });

    // üîπ Soumission du formulaire (PUT)
    document.getElementById("postForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const contratModifie = {
        Type_contrat: document.getElementById("Type_contrat").value,
        Date_contrat: document.getElementById("Date_contrat").value,
        Debut_contrat: document.getElementById("Debut_contrat").value,
        Fin_contrat: document.getElementById("Fin_contrat").value,
        Fonction: document.getElementById("Fonction").value,
      };

      fetch(`${API_CONTRATS}/${contratId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(contratModifie),
      })
        .then(res => {
          if (res.ok) {
            alert("‚úÖ Contrat modifi√© avec succ√®s !");
            window.history.back();
          } else {
            alert("‚ùå Erreur lors de la modification du contrat !");
          }
        })
        .catch(err => {
          console.error("Erreur :", err);
          alert("Erreur r√©seau ou serveur !");
        });
    });
  </script>
</body>

</html>
