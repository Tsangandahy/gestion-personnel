<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../style.mot_pass.css">
  <title>PersoManager</title>

  <style>
    /* ======== STYLE DU BOUTON RETOUR ======== */
    .btn-retour {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background-color: #007bff; /* Bleu vif */
      color: white;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      text-decoration: none;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .btn-retour i {
      font-size: 16px;
    }

    .btn-retour:hover {
      background-color: #0056b3;
      transform: translateY(-2px);
    }

    /* Ajustement navbar */
    .navbar ul {
      display: flex;
      gap: 15px;
      align-items: center;
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .navbar li {
      display: flex;
      align-items: center;
    }

    .btn-logout {
      background-color: #dc3545;
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      text-decoration: none;
      transition: background-color 0.3s ease;
    }

    .btn-logout:hover {
      background-color: #a71d2a;
    }
  </style>
</head>

<body>

  <nav class="navbar">
    <div class="logo">
      <h1>Liste de contrat par personne</h1>
    </div>

    <div class="nav-links">
      <ul>
        <!-- üü¶ Bouton Retour remplac√© -->
        <li>
          <a href="page_de_garde_gestion_personnel.html" class="btn-retour">
            <i class="fa-solid fa-arrow-left"></i> Retour
          </a>
        </li>

        <!-- üü° Nom utilisateur ici -->
          <li class="Util2">
          <label style="color: white;">Utilisateur :</label>
          <span class="nom">---</span>
        </li>

        <!-- üî¥ Bouton D√©connexion -->
        <li><a href="#" id="btn_quitter" class="btn-logout">D√©connexion</a></li>
      </ul>
    </div>

    <img src="../Image/menu_humberger.JPG" alt="menu" class="menu_humberger">
  </nav>

  <header>
    <div class="contrat_header">
      <div style="width: 100%;">
        <table class="tableau_en_tete">
          <tr>
            <td>Nom</td>
            <td>:</td>
            <td><input type="text" id="nom" readonly></td>
            <td><img src="../Image/image_personnel.jpg" alt="icone"
                width="30" height="30"
                class="petit_image"></td>
          </tr>
          <tr>
            <td>Pr√©nom</td>
            <td>:</td>
            <td><input type="text" id="prenom" readonly></td>
          </tr>
          <tr style="display: none;">
            <td>id_personnel</td>
            <td>:</td>
            <td><input type="text" id="Id_personnel_input" readonly></td>
          </tr>
        </table>

        <div id="contrats_section" style="margin:20px 0; display:block;width: 100%;">
          <h3 style="display: none;">Contrats de <span id="nom_personnel_contrat"></span></h3>
          <div>
            <table class="table_SF" border="1" cellpadding="5">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Date contrat</th>
                  <th>D√©but</th>
                  <th>Fin</th>
                  <th>Fonction</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="contrats_table">
                <tr>
                  <td colspan="6">S√©lectionnez un personnel</td>
                </tr>
              </tbody>
            </table>
          </div>
          <button id="btn-submit" style="display: none;">Valider</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Liste personnel -->
  <div class="list_personnel">
    <input type="text" class="Recherche" placeholder="Rechercher...">
    <button class="fermer_liste">X</button>
    <table>
      <thead>
        <tr>
          <th>Nom</th>
          <th>Pr√©nom</th>
          <th>CIN</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="personnel-contener"></tbody>
    </table>
    <div id="pagination"></div>
  </div>

  <input type="hidden" id="Id_personnel">
  <input type="hidden" id="Id_personnel_contrat">

  <script>
    // ==========================
    // üü¢ GESTION UTILISATEUR
    // ==========================
    const nomUtilisateur = localStorage.getItem("nom_utilisateur");
    if (nomUtilisateur) {
      document.querySelector(".nom").textContent = nomUtilisateur;
    } else {
      window.location.href = "../index.html";
    }

    document.getElementById("btn_quitter").addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.removeItem("nom_utilisateur");
      window.location.href = "../index.html";
    });

    // ==========================
    // üü¢ MENU HUMBERGER
    // ==========================
    const menuhumberger = document.querySelector(".menu_humberger");
    const navlinks = document.querySelector(".nav-links");
    menuhumberger.addEventListener('click', () => {
      navlinks.classList.toggle('mobile-menu');
    });

    // ==========================
    // üü¢ GESTION PERSONNEL / CONTRAT
    // ==========================
    const API_URL = "http://localhost:5000/api/personnels";
    const personnelContainer = document.getElementById("personnel-contener");
    const listpersonnel = document.querySelector(".list_personnel");
    const petitimage = document.querySelector(".petit_image");
    const fermerliste = document.querySelector(".fermer_liste");

    petitimage.addEventListener('click', () => {
      listpersonnel.classList.toggle('vue');
    });

    fermerliste.addEventListener('click', () => {
      listpersonnel.classList.remove('vue');
    });

    let currentPage = 1;
    const rowsPerPage = 6;
    let allPersonnels = [];

    function chargerpersonnel() {
      fetch(API_URL)
        .then(res => res.json())
        .then(data => {
          allPersonnels = data;
          afficherPersonnels();
          afficherPagination();
        })
        .catch(err => console.error("Erreur :", err));
    }

    function afficherPersonnels() {
      personnelContainer.innerHTML = "";
      if (allPersonnels.length === 0) {
        personnelContainer.innerHTML = `<tr><td colspan="4">Aucun personnel trouv√©</td></tr>`;
        return;
      }
      let start = (currentPage - 1) * rowsPerPage;
      let end = start + rowsPerPage;
      let personnels = allPersonnels.slice(start, end);

      personnels.forEach((personnel, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${personnel.Nom}</td>
          <td>${personnel.Prenom}</td>
          <td>${personnel.CIN}</td>
          <td><button class="btn-valider"><<</button></td>
        `;
        personnelContainer.appendChild(row);
      });

      document.querySelectorAll(".btn-valider").forEach((btn, i) => {
        btn.addEventListener("click", () => {
          const personnel = personnels[i];
          document.getElementById("Id_personnel").value = personnel._id;
          document.getElementById("Id_personnel_contrat").value = personnel._id;
          document.getElementById("Id_personnel_input").value = personnel._id;
          document.getElementById("nom").value = personnel.Nom;
          document.getElementById("prenom").value = personnel.Prenom;
          listpersonnel.classList.remove("vue");
          chargerContrats(personnel._id, personnel.Nom + " " + personnel.Prenom);
        });
      });
    }

    function afficherPagination() {
      const paginationContainer = document.getElementById("pagination");
      paginationContainer.innerHTML = "";
      const totalPages = Math.ceil(allPersonnels.length / rowsPerPage);

      const prev = document.createElement("button");
      prev.textContent = "‚óÄ";
      prev.disabled = currentPage === 1;
      prev.addEventListener("click", () => {
        currentPage--;
        afficherPersonnels();
        afficherPagination();
      });
      paginationContainer.appendChild(prev);

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        if (i === currentPage) {
          btn.style.fontWeight = "bold";
          btn.style.backgroundColor = "#ddd";
        }
        btn.addEventListener("click", () => {
          currentPage = i;
          afficherPersonnels();
          afficherPagination();
        });
        paginationContainer.appendChild(btn);
      }

      const next = document.createElement("button");
      next.textContent = "‚ñ∂";
      next.disabled = currentPage === totalPages;
      next.addEventListener("click", () => {
        currentPage++;
        afficherPersonnels();
        afficherPagination();
      });
      paginationContainer.appendChild(next);
    }

    // ==========================
    // üîç RECHERCHE
    // ==========================
    const rechercheInput = document.querySelector(".Recherche");
    rechercheInput.addEventListener("input", () => {
      const recherche = rechercheInput.value.toLowerCase();
      const personnelsFiltres = allPersonnels.filter(personnel =>
        personnel.Nom.toLowerCase().includes(recherche) ||
        personnel.Prenom.toLowerCase().includes(recherche) ||
        personnel.CIN.toLowerCase().includes(recherche)
      );
      afficherPersonnelsFiltrees(personnelsFiltres);
    });

    function afficherPersonnelsFiltrees(personnelsFiltres) {
      personnelContainer.innerHTML = "";
      if (personnelsFiltres.length === 0) {
        personnelContainer.innerHTML = `<tr><td colspan="4">Aucun personnel trouv√©</td></tr>`;
        return;
      }

      personnelsFiltres.forEach((personnel, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${personnel.Nom}</td>
          <td>${personnel.Prenom}</td>
          <td>${personnel.CIN}</td>
          <td><button class="btn-valider"><<</button></td>
        `;
        personnelContainer.appendChild(row);
      });

      document.querySelectorAll(".btn-valider").forEach((btn, i) => {
        btn.addEventListener("click", () => {
          const personnel = personnelsFiltres[i];
          document.getElementById("Id_personnel").value = personnel._id;
          document.getElementById("Id_personnel_contrat").value = personnel._id;
          document.getElementById("Id_personnel_input").value = personnel._id;
          document.getElementById("nom").value = personnel.Nom;
          document.getElementById("prenom").value = personnel.Prenom;
          listpersonnel.classList.remove("vue");
          chargerContrats(personnel._id, personnel.Nom + " " + personnel.Prenom);
        });
      });
    }

    // ==========================
    // üìÑ CHARGEMENT DES CONTRATS
    // ==========================
    function chargerContrats(idpersonnel, nom) {
      fetch(`http://localhost:5000/api/contrats/personnel/${idpersonnel}`)
        .then(res => res.json())
        .then(data => {
          const tableBody = document.getElementById("contrats_table");
          const nomPersonnelContrat = document.getElementById("nom_personnel_contrat");
          nomPersonnelContrat.innerText = nom;
          tableBody.innerHTML = "";

          if (data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6">Aucun contrat trouv√©</td></tr>`;
          } else {
            data.forEach(contrat => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${contrat.Type_contrat}</td>
                <td>${new Date(contrat.Date_contrat).toLocaleDateString()}</td>
                <td>${new Date(contrat.Debut_contrat).toLocaleDateString()}</td>
                <td>${new Date(contrat.Fin_contrat).toLocaleDateString()}</td>
                <td>${contrat.Fonction}</td>
                <td>
                  <button class="btn-modifier" onclick="modifierContrat('${contrat._id}')" title="Modifier">
                    <i class="fa-solid fa-pen-to-square"></i>
                  </button>
                  <button class="btn-supprimer" onclick="supprimerContrat('${contrat._id}')" title="Supprimer">
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </td>
              `;
              tableBody.appendChild(row);
            });
          }
        })
        .catch(err => console.error("Erreur chargement contrats :", err));
    }

    // ==========================
    // ‚úèÔ∏è MODIFIER / SUPPRIMER
    // ==========================
    function supprimerContrat(id) {
      if (confirm("Voulez-vous vraiment supprimer ce contrat ?")) {
        fetch(`http://localhost:5000/api/contrats/${id}`, { method: "DELETE" })
          .then(res => {
            if (res.ok) {
              alert("Contrat supprim√© !");
              const personnelId = document.getElementById("Id_personnel").value;
              chargerContrats(personnelId, document.getElementById("nom").value + " " + document.getElementById("prenom").value);
            } else {
              alert("Erreur lors de la suppression");
            }
          })
          .catch(err => console.error("Erreur :", err));
      }
    }

    function modifierContrat(idContrat) {
      const nom = document.getElementById("nom").value;
      const prenom = document.getElementById("prenom").value;
      window.location.href = `persocontratmodif.html?id=${idContrat}&nom=${encodeURIComponent(nom)}&prenom=${encodeURIComponent(prenom)}`;
    }

    window.onload = chargerpersonnel;
  </script>
</body>
</html>
