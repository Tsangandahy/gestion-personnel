<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../style.mot_pass.css">
  <title>PersoManager</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="logo">
      <h1>Liste de personnel</h1>
    </div>

    <div class="nav-links">
      <ul>
        <li>
          <a href="page_de_garde_gestion_personnel.html" class="btn-retour" title="Retour">
            <i class="fa-solid fa-arrow-left"></i> Retour
          </a>
        </li>
        <li class="Util2">
          <label style="color: white;">Utilisateur :</label>
          <span class="user-info">
            <span class="nom">---</span>
            <span class="role">(---)</span>
          </span>
        </li>
        <li>
          <a href="#" id="btn_quitter" class="btn-logout">
            <i class="fa-solid fa-right-from-bracket"></i> Déconnexion
          </a>
        </li>
      </ul>
    </div>

    <img src="../Image/menu_humberger.JPG" alt="menu" class="menu_humberger">
  </nav>

  <!-- Contenu -->
  <div class="contener">
    <table class="table_SF" border="1" cellpadding="1" style="margin-top: 18px;">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Prénom</th>
          <th>CIN</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="personnel-contener"></tbody>
    </table>
    <div id="pagination"></div>
  </div>

  <script>
    // =========================
    // 🔹 Gestion utilisateur
    // =========================
    const nomUtilisateur = localStorage.getItem("nom_utilisateur");
    const roleUtilisateur = localStorage.getItem("role_utilisateur");

    if (nomUtilisateur && roleUtilisateur) {
      document.querySelector(".nom").textContent = nomUtilisateur;
      const roleAffichage = roleUtilisateur.charAt(0).toUpperCase() + roleUtilisateur.slice(1);
      document.querySelector(".role").textContent = `(${roleAffichage})`;
    } else {
      window.location.href = "../index.html";
    }

    document.getElementById("btn_quitter").addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.removeItem("nom_utilisateur");
      localStorage.removeItem("role_utilisateur");
      window.location.href = "../index.html";
    });

    // =========================
    // 🔹 Gestion du personnel
    // =========================
    const API_URL = "http://localhost:5000/api/personnels";
    const personnelContainer = document.getElementById("personnel-contener");

    let currentPage = 1;
    const rowsPerPage = 10;
    let allPersonnels = [];

    async function chargerPersonnel() {
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error("Erreur de chargement du personnel");
        allPersonnels = await res.json();
        afficherPersonnels();
        afficherPagination();
      } catch (err) {
        console.error("Erreur :", err);
        alert("Impossible de charger la liste des personnels.");
      }
    }

    function afficherPersonnels() {
      personnelContainer.innerHTML = "";
      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const personnels = allPersonnels.slice(start, end);

      if (personnels.length === 0) {
        personnelContainer.innerHTML = "<tr><td colspan='4'>Aucun personnel trouvé</td></tr>";
        return;
      }

      personnels.forEach(personnel => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${personnel.Nom}</td>
          <td>${personnel.Prenom}</td>
          <td>${personnel.CIN}</td>
          <td>
            <button class="action-btn edit-btn" onclick="modifierPersonnel('${personnel._id}')">
              <i class="fa-solid fa-pen-to-square"></i>
            </button>
            <button class="action-btn delete-btn" onclick="supprimerPersonnel('${personnel._id}', this)">
              <i class="fa-solid fa-trash"></i>
            </button>
          </td>
        `;
        personnelContainer.appendChild(row);
      });
    }

    function afficherPagination() {
      const paginationContainer = document.getElementById("pagination");
      paginationContainer.innerHTML = "";

      const totalPages = Math.ceil(allPersonnels.length / rowsPerPage);

      const prev = document.createElement("button");
      prev.textContent = "◀";
      prev.disabled = currentPage === 1;
      prev.addEventListener("click", () => {
        currentPage--;
        afficherPersonnels();
        afficherPagination();
      });
      paginationContainer.appendChild(prev);

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        if (i === currentPage) {
          btn.style.fontWeight = "bold";
          btn.style.backgroundColor = "#ddd";
        }
        btn.addEventListener("click", () => {
          currentPage = i;
          afficherPersonnels();
          afficherPagination();
        });
        paginationContainer.appendChild(btn);
      }

      const next = document.createElement("button");
      next.textContent = "▶";
      next.disabled = currentPage === totalPages;
      next.addEventListener("click", () => {
        currentPage++;
        afficherPersonnels();
        afficherPagination();
      });
      paginationContainer.appendChild(next);
    }

    function modifierPersonnel(id) {
      window.location.href = `perso_modifier.html?id=${id}`;
    }

    // ✅ Corrigé : rattachement de la fonction à window
    window.supprimerPersonnel = async function (id, bouton) {
      if (!confirm("Voulez-vous vraiment supprimer ce personnel ?")) return;

      try {
        const response = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
        if (!response.ok) {
          const text = await response.text();
          throw new Error(`Erreur HTTP ${response.status} : ${text}`);
        }

        // Supprimer la ligne du tableau
        const ligne = bouton.closest("tr");
        if (ligne) ligne.remove();

        // Supprimer du tableau local
        allPersonnels = allPersonnels.filter(p => p._id !== id);

        afficherPagination();
        alert("✅ Personnel supprimé avec succès !");
      } catch (err) {
        console.error("Erreur lors de la suppression :", err);
        alert("❌ Impossible de supprimer le personnel (voir console).");
      }
    };

    // Charger à l’ouverture
    window.onload = chargerPersonnel;

    // Menu hamburger
    const menuhumberger = document.querySelector(".menu_humberger");
    const navlinks = document.querySelector(".nav-links");
    menuhumberger.addEventListener("click", () => {
      navlinks.classList.toggle("mobile-menu");
    });
  </script>
</body>
</html>
